Часть 3. Обеспечение качества
=================

## Расположение серверов

![Server locations](./servers.png "Расположение серверов")

Сервера расположены вблизи сетевых магистралей, а также в местах с высокой
плотностью населения. Сервера Backend и S3 хранилища расположены в одном месте
с целью повышения надежности и скорости работы приложения.

Вместе с Backend серверами, недалеко от москвы, расположены 6 фронтенд серверов,
которые покрывают нагрузку из Москвы и ее окрестностей.

Для понижения задержки при трансляции видео и отдаче статики, в окрестностях
Новосибирска и Хабаровска расположены еще 2 пары фронтенд серверов.

В качестве провайдера стоит выбрать Ростелеком или ТТК, поскольку они
имеют наибольшее покрытие в РФ

## Схема балансировки нагрузки

Запросы к Frontend серверу балансируются при помощи Geo-based DNS.

Нагрузка между Backend серверами распределяется при помощи L7 балансировщика.

Каждое из двух S3 хранилищ способно выдержать всю нагрузку, поэтому выбор делается 
произвольным образом. В случае, если S3 не отвечает более минуты, сервер 
перенаправляет нагрузку на второе хранилище и уведомляет человека о недоступности 
хранилища.

Остальной внутрипроектный трафик также будет балансироваться при помощи 
L7 балансировщика. На каждый фронтенд сервер приходится по одному балансировщику.

Фронтенд сервера при помощи кворума решают, упал ли сервер. Если
у более чем половины серверов нет связи с сервером (пинг выполняется раз в минуту),
то сервер считается упавшим, и адрес сервера убирается из конфига DNS. После чего 
требуется вмешательство человека. Стоит также добавить, что при такой схеме
нет необходимости резервировать L7 балансеровщик, поскольку в случае падения сервера
нагрузка и так перейдет на другие.

## Обеспечение отказоустойчивости

Необходимо свести к минимуму вмешательство человека в систему. На этапе разработки
это достигается за счет автоматизации процесса разработки и тестирования:

1. Использование TDD там, где это возможно

2. Написание большого количества smoke-, unit-, end-to-end-тестов.

3. Регулярные code review

4. Использование Agile/scrum подходов к разработке (Позволяет ускорить процесс разработки).

5. Использование CI и CD.

На этапе промышленной эксплуатации необходимо использовать правильные 
метрики, которые позволят достаточно быстро отреагировать на неисправность
системы. Такими метриками могут быть:

1. Количество пройденных тестов. При неисправность сервиса ученики не могут
отправить тест, либо просмотреть лекции.

2. Количество проверяемых учителями тестов. Если учителя стали проверять меньше
тестов, то существует вероятность, что тесты не доходят до учителей, или
учителя не могут проверить тесты.

3. Средний балл учеников. Если балл падает, то вероятно преподаватели не получают
тесты от учеников. Также есть вероятность, что преподаватели получают задания 
не тех учеников).

4. Среднее время просмотра лекций. В случае падения можно предположить, что
есть проблемы с отдачей видео материалов.

Стоит также тщательно следить за физическим оборудованием, и в случае необходимости
добавлять резервные сервера, либо улучшать существующие.

## Используемые материалы:

[Плотность населения России](http://www.statdata.ru/nasel_regions)

[Магистральные сети](https://www.gea.site/2018/04/638/)

[L4 vs L7](https://www.nginx.com/resources/glossary/layer-4-load-balancing/)
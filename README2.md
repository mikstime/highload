Часть 2. Архитектура приложения
=================

## Логическая схема базы данных

Наибольший интерес с точки зрения архитектуры представляет сервис тестирования.

Наиболее важные сущности: студент (`Student`), преподаватель (`Teacher`), 
урок (`Lesson`) и сам тест (`Test`).

Опустим вторичные данные на подобие места учебы, информации о классе/группе 
ученика, месте работы учителя, личных данных, и так далее.

### Student

Сущность `Student` хранит информацию о студенте, и идентифицируется по **id**.
Студент способен написать тест и отправить его на проверку учителю.

| Student |
| :------ |
|  **id** |

### Teacher

Сущность `Teacher` хранит информаицю о преподавателе, и идентифицируется по **id**.
Преподаватель способен проверять тесты, написанные учениками.

| Teacher |
| :------ |
|  **id** |

### Lesson

Сущность `Lesson` хранит информацию об уроке, и идентифицируется по **id**.
С `Lesson` связана информация о тестах, пройденных учениками, 
и, проверенных учителями.

|    Lesson     |
| :---------- |
|   **id**    |

### Test

Сущность `Test` хранит информаицю о тесте, и идентифицируется по **id**.
Помимо этого `Test` содержит информацию о студенте и преподавателе,
статус проверки и оценку. В базе данных хранится лишь самая необходимая 
информация о тесте (содержание самого теста находится в другом месте).

|    Test     |
| :---------- |
|   **id**    |
|  student_id |
|  teacher_id |
|  lesson_id  |
|   status    |
|    mark     |
|    name     |
| description |

![DB schema](./schema.png "Схема базы данных")

### Физическая система хранения

Поскольку для данной системы редки конкурентные операции записи, операции 
изменения данных, и данные слабо связаны между собой, то удобно хранить 
информацию о самих сущностях в документоориентированном хранилище или в 
хранилище типа ключ-значение, а информацию о связях между ними хранить в 
реляционной базе данных.

Для хранения информации о студентах, преподавателях и тестах будет использоваться
колоночная база данных в силу большей производительности по сравнению с 
документоориентированными базами, а также отсутствия подходящих решений на основе
хранилищ типа ключ-значение. При необходимости изменения данных, приложение 
будет считывать старую версию данных, вносить изменение и перезаписывать значение.

При этом, поскольку информация о статусе тестов хранятся в реляционной базе данных,
для изменения статуса и проставления оценки не нужно изменять данные в 
колоночном хранилище, а лишь в реляционной базе данных.

**SCYLLA** – хранение тестов, данных учеников и преподавателей 
(слабоструктурированный json).

###### Сами странички с уроками отдаются Frontend сервером, так что нет необходимости хранить их в БД.

Обоснование: первоначально планировалось использовать DynamoDB в силу простоты
горизонтального масштабирования и наличия поддержки ACID. Однако отсутствие 
серверов в России (пинг достигает 130), а также отсутствие возможности развернуть
базу на собственных серверах привело к необходимости поиска аналогов. Выбор пал
на колоночные базы Cassandra и SCYLLA. Поскольку SCYLLA написана на C++, и имеет
большую скорость работы, чем Cassandra. Также обе базы данных имеют открытый 
исходный код. SCYLLA также легко масштабируется в ширину, скрипты на lua 
(но не триггеры), и не поддерживает ACID. Отсутствие ACID некритично, 
поскольку единственное место, где возможны конкурентные действия – изменение 
личных данных пользователя и операции удаления.

**Postgres** – хранение части информации об учениках, преподавателях и тестах, 
а также связей между ними.

Обоснование: Одна из лучших реляционных баз данных.

Подитожим: для просмотра информации о тесте/ученике/преподавателе будет
достаточно обратиться к ScyllaDB. Для изменения статуса теста – только к
Postgres. В случае необходимости создания или удаления записи в любую из таблиц,
начинается транзакция в postgres, вносится значение, затем в ScyllaDB, и 
лишь затем транзакция завершается.

### Шардирование данных

Ежедневно каждый ученик создает несколько тестов, а учитель, как правило, в 
течение пары недель их проверяет. Таким образом, наиболее запрашиваемыми 
являются тесты, созданные в течение пары недель. Тогда имеет смысл создавать 
партиции таблиц с тестами каждые две недели.

Для экономии, данные старше одного месяца можно хранить на старых жестких дисках 
(Задержка не так важна для данных запросов).

Несложно посчитать, что за один месяц накапливается примерно 875 ТБ данных,
которые сложно уместить на одну машину. Если учесть, что люди редко переезжают 
из региона в регион, то удобно использовать шардирование данных тестов по 
географическому признаку.

### Пиковая нагрузка

Основные типы запросов:

- Просмотр списка уроков - 1 SELECT в Postgres
- Просмотр страницы урока - 1 запрос к ScyllaDB

- Просмотр страницы ученика - 1 запрос к ScyllaDB
- Просмотр тестов ученика - 1 SELECT в Postgres
- Просмтр списка тестов к уроку (пройденных учеником) - 1 SELECT в Postgres

- Просмотр страницы преподавателя - 1 запрос к ScyllaDB
- Просмотр тестов преподавателя - 1 запрос к ScyllaDB
- Просмотр списка тестов к уроку (отправленных преподавателю) - 1 SELECT в Postgres

- Отправка теста - 1 INSERT в Postgres и 1 запрос к ScyllaDB
- Проверка теста - 1 UPDATE в Postgres

Как мы раньше посчитали, в течение 4.5 часов ежедневно на сайт заходит около
14.6 млн пользователей. Из них 0.65 млн – преподаватели, оставшиеся 13.8 млн – ученики.
Пусть средний ученик за день проходит 4 теста, просматривает 5 уроков, 
5 раз просматривает список доступных уроков.

Число запросов на одного ученика: 4 + 5 + 5 = 14 за 4.5 часа.

Тогда QPS учеников: 13.8 млн \* 14 / 4.5 / 3600 ~ **12000**

Преподаватель в среднем ежедневно проверяет тесты, присланные его учениками. 
В среднем классе учится 20-30 учеников (возьмем 25), тогда ежедневно преподаватель
проверяет 25 тестов. Также преподаватель просматривает 5 уроков, 
5 раз просматривает список доступных уроков.

Число запросов на одного учителя: 25 + 5 + 5 = 35. за 4.5 часа.

Тогда QPS преподавателей: 0.65 млн \* 35 / 4.5 / 3600 ~ **1400**

Итоговый QPS: 1400 + 12000 ~ **13400**

## Выбор прочих технологий

Видео материалы и материалы лекций будут отдаваться при помощи `nginx`,
балансировка нагрузки и кэширование запросов также будет лежать на nginx.
Для L7 балансировки в nginx имеется 3 алгоритма (round-robin, least-connected, 
ip-hash), а также поддержка весов.

Клиентское приложение (сайт) будет написан на Javascript, в частности с использованием 
технологий Facebook: React, Redux, Relay. С учетом того, что новые уроки
на сайт добавляются относительно редко, большая часть материалов будет
хранится в виде статических файлов благодаря Server Side Rendering.

В качестве языка для серверного приложения выбран Rust. Rust является системным
языком и позволяет писать высокопроизводительные приложения, в Rust удобно 
организована работа с потоками, а также корутинами (async-std). Возможность
работать с соединением на достаточно низком уровне позволяет писать намного 
более производительные приложения. При этом скорость написания кода на Rust
значительно выше, чем на C++ благодаря более информативным ошибкам и хорошему
отладчику.

Для написания микросервисов, на которые не возложена большая нагрузка, будет
использован Java, для части производительных микросервисов – c++ с целью
охвата большей части рынка программистов.

Для коммуникации между микросервисами удобно использовать протокол gRPC. 
Взаимодействие Frontend и Backend серверов происходит посредством https.

Minio – S3 хранилище. Готовое к масштабированию S3 объектное хранилище с 
открытым исходным кодом. 

## Расчет нагрузки и потребного оборудования

### Нагрузка на Frontend-сервера

В обязанности Frontend сервера входит отдача видео и web-страниц.

Материалы лекций являются часто запрашиваемыми, поэтому информация будет
храниться на 4-х терабайтных SSD (RAID 5/6).

Также для повышения производительности будем кэшировать лекции (как правило 
запрашиваются лекции, которые должны быть по учебной программе в этот день).

Возьмем средненький процессор, поскольку данный сервер в основном занимается
отдачей статики, и практически не производит вычислений. Пусть в материнской
плате 4 плашки для оперативной памяти, тогда, используя плашки по 32 ГБ, получаем
128 ГБ оперативной памяти.

Как мы ранее посчитали, в пике объем трафика для данного типа нагрузки 
достигает 70 Гбит/сек при этом фронтенд сервера также проксируют нагрузку на
бекенд, тогда общая нагрузка составляет примерно 73,5 Гбит/сек, при пропускной 
способности сети в 10 Гбит/сек нам потребуется *8 фронтенд серверов*. Для
повышения отказоустойчивость используем 2 резервных сервера.

| Фронтенд сервер |
| :-------------- |
|    4 ТБ ssd     |
|    128 ГБ RAM   |
|   8-ядерный i7  |

## Нагрузка на Backend сервера

Backend-сервер ответственнен за хранение данных о пользователях, тестах и 
активных сессиях.

Объем данных пользователей и тестов невелик (фото хранятся в другом месте, 
так что остается только текстова информация), которые без проблем умещаются на 
одной машине. 

В пике через сервера проходит 3.5 Гбит трафика, 90+% из которого проксируется в
S3 хранилище (основной трафик – тесты с картинками).

Очевидно, что данные учиников и учителей малы по сравнению с тестами (около 100 ГБ).
Если размер одного теста составляет 0.5 КБ (только текстовая часть, 250 слов),
то общий занимаемый объем тестов – 35 ТБ.

Пусть объем трафика, который необходимо обработать Backend-серверу составляет
10% от входящего – 0.36 Гбит/сек. Данный объем без проблем покрывается скоростью
записи одного SSD, тогда можно использовать одинадцать 4-х терабайтных дисков в
RAID 6 (Емкость 36 ТБ, скорость чтения x9, 2 отказа).

Таким образом, нам достаточно одной машины для покрытия нагрузки. Однако для 
повышения отказаустойчивости используем 3 машины (один узел ведущий), расположив
их в трех регионах России.

|   Backend сервер  |
| :---------------: |
|      36ТБ SSD     |
| Средний процессор |
|    Средняя RAM    |

## Нагрузка на S3

Как было ранее подсчитано, на серверах хранится около 21 ПБ материала 
(скорость записи 3.5 Гбит/сек),связанного с тестами. При этом, операции чтения 
достаточно редки, и читаются, как правило данные за последние две недели. 
Поэтому данные целесобразно хранить на HDD.

Используя стенды от WD, в RAID 10 получаем примерно 640 ТБ на стенд, и возможность 
отказа у 1 диска из 65. Таким образом нам понадобится 36 таких стендов.
(Скорость записи возрастает в 32 раза, и покрывает входящий трафик с запасом).

Имеет смысл реплецировать данные на второе хранилище для повышения надежности,
а также для возможности расположить их в двух разных регионах России с целью
уменьшения времени обработки запросов.

|         S3 стенд        |
| :---------------------: |
|        1260 ТБ HDD      |
|     Мощный процессор    |
| Куча оперативной памяти |

## Используемые материалы:

[Kilobytes to Words](http://extraconversion.com/data-storage/kilobytes/kilobytes-to-words.html)

[DynamoDB sharding](https://aws.amazon.com/ru/blogs/database/choosing-the-right-number-of-shards-for-your-large-scale-amazon-dynamodb-table/)

[DynamoDB vs Redis](https://stackoverflow.com/questions/56870326/dynamodb-vs-redis)

[DynamoDB vs MongoDB vs Cassandra](https://db-engines.com/en/system/Amazon+DynamoDB%3BCassandra%3BMongoDB)

[Cassandra vs. MongoDB vs. ScyllaDB](https://db-engines.com/en/system/Cassandra%3BMongoDB%3BScyllaDB)

[DynamoDB alternatives](https://www.quora.com/What-are-open-source-alternatives-to-Amazon-DynamoDB)

[NGINX L7 ](https://nginx.org/en/docs/http/load_balancing.html)

[NGINX Content Caching](https://docs.nginx.com/nginx/admin-guide/content-cache/content-caching/)

[Число учеников в одном классе](https://naviny.media/article/20190905/1567698413-skolko-detey-dolzhno-byt-v-klasse-dvadcat-ili-shestdesyat)

[PostgreSQL and MySQL: Millions of Queries per Second](https://www.percona.com/blog/2017/01/06/millions-queries-per-second-postgresql-and-mysql-peaceful-battle-at-modern-demanding-workloads/)

[Сравнение SKYLLA и Cassandra](https://blog.octo.com/en/scylladb-vs-cassandra-towards-a-new-myth/)

[Сервисы Amazon](https://habr.com/ru/post/348542/)

[Ultrastar Serv60+8 ](https://www.westerndigital.com/products/storage-platforms/ultrastar-serv60-8-hybrid-server)

[Raid6 calculator](http://www.raid-calculator.com/default.aspx)

[20TB HDD](https://www.westerndigital.com/products/data-center-drives/ultrastar-dc-hc600-series-hdd)

[MCS](https://mcs.mail.ru/storage/)